"""Secrets Manager integration — generates or imports secrets per environment."""

from __future__ import annotations

import os

from aws_cdk import aws_secretsmanager
from constructs import Construct


class SecretsProvider(Construct):
    """Creates Secrets Manager secrets for a single environment.

    Each ``SecretConfig`` (from the project TOML) becomes one secret entry.
    """

    def __init__(
        self,
        scope: Construct,
        construct_id: str,
        *,
        project_name: str,
        env_name: str,
        secret_configs: list,
    ) -> None:
        super().__init__(scope, construct_id)

        self._secret_arns: dict[str, str] = {}
        prefix = f"{project_name}-{env_name}"

        for cfg in secret_configs:
            if cfg.source == "generate":
                if not cfg.generate_once:
                    raise ValueError(
                        f"Secret '{cfg.name}' has generate_once=false, "
                        "which is not supported yet."
                    )
                secret = aws_secretsmanager.Secret(
                    self,
                    f"Secret-{cfg.name}",
                    secret_name=f"{prefix}-{cfg.name.lower().replace('_', '-')}",
                    generate_secret_string=aws_secretsmanager.SecretStringGenerator(
                        password_length=cfg.length,
                        exclude_punctuation=True,
                    ),
                )
                self._secret_arns[cfg.name] = secret.secret_full_arn or secret.secret_arn
            else:
                # Source is "env" — read the name/ARN of an existing secret from
                # the deployer's local environment variable.
                env_secret_ref = os.environ.get(cfg.name, "").strip()
                if not env_secret_ref:
                    raise ValueError(
                        f"Secret '{cfg.name}' source is 'env' but the "
                        f"environment variable is not set"
                    )
                if env_secret_ref.startswith("arn:"):
                    imported = aws_secretsmanager.Secret.from_secret_complete_arn(
                        self,
                        f"SecretImport-{cfg.name}",
                        secret_complete_arn=env_secret_ref,
                    )
                else:
                    imported = aws_secretsmanager.Secret.from_secret_name_v2(
                        self,
                        f"SecretImport-{cfg.name}",
                        secret_name=env_secret_ref,
                    )
                self._secret_arns[cfg.name] = imported.secret_arn

    def get_arns_for(self, names: list[str]) -> dict[str, str]:
        """Return a mapping of secret name → full ARN for the given names."""
        result: dict[str, str] = {}
        for name in names:
            if name in self._secret_arns:
                result[name] = self._secret_arns[name]
        return result
